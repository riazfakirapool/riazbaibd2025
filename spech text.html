<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡ßç‡¶™‡¶ø‡¶ö ‡¶ü‡ßÅ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶è‡¶°‡¶ø‡¶ü‡¶∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f3f4f6;
        }

        .mic-active {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Editor Styles */
        #resultText {
            overflow-y: auto;
            min-height: 300px;
        }
        #resultText:empty:before {
            content: attr(placeholder);
            color: #d1d5db;
            pointer-events: none;
            display: block; 
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printSection, #printSection * {
                visibility: visible;
            }
            #printSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 2cm;
                background: white;
                box-shadow: none;
                border-radius: 0;
            }
            #resultText {
                border: none;
                height: auto;
                overflow: visible;
            }
            /* Hide placeholders and UI elements in print */
            #resultText:empty:before {
                content: "";
            }
            #translateBtn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col h-[90vh]">
        
        <!-- Header (Hidden when printing) -->
        <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-md z-10">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <span>üé§</span> ‡¶∏‡ßç‡¶™‡¶ø‡¶ö ‡¶è‡¶°‡¶ø‡¶ü‡¶∞
                </h1>
            </div>
            
            <!-- Language Selector -->
            <div>
                <select id="languageSelect" class="bg-indigo-700 text-white text-sm rounded px-3 py-1.5 border border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-300 cursor-pointer">
                    <option value="bn-BD" selected>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (BD)</option>
                    <option value="bn-IN">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (IN)</option>
                    <option value="en-US">English (US)</option>
                </select>
            </div>
        </div>

        <!-- Controls Toolbar (Start/Stop) -->
        <div class="bg-gray-50 border-b border-gray-200 p-3 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <button id="startBtn" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-5 py-1.5 rounded-full font-semibold transition-all shadow-sm active:scale-95 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    <span>‡¶∂‡ßÅ‡¶∞‡ßÅ (Start)</span>
                </button>
                <button id="stopBtn" class="hidden flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-5 py-1.5 rounded-full font-semibold transition-all shadow-sm active:scale-95 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    <span>‡¶•‡¶æ‡¶Æ‡ßÅ‡¶® (Stop)</span>
                </button>
            </div>
            <div class="text-sm font-medium text-gray-500" id="statusText">‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶¨‡¶®‡ßç‡¶ß</div>
        </div>

        <!-- Formatting Toolbar (Bold, Italic, Undo, Redo, etc.) -->
        <div class="bg-white border-b border-gray-200 p-2 flex flex-wrap items-center gap-2 sticky top-0 z-10 shadow-sm">
            <!-- Formatting Group -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1 gap-1">
                <button onclick="formatDoc('bold')" class="p-2 hover:bg-gray-300 rounded text-gray-700" title="Bold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
                </button>
                <button onclick="formatDoc('italic')" class="p-2 hover:bg-gray-300 rounded text-gray-700" title="Italic">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>
                </button>
                <button onclick="formatDoc('underline')" class="p-2 hover:bg-gray-300 rounded text-gray-700" title="Underline">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg>
                </button>
            </div>

            <div class="w-px h-8 bg-gray-300 mx-1"></div>

            <!-- History Group -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1 gap-1">
                <button onclick="formatDoc('undo')" class="p-2 hover:bg-gray-300 rounded text-gray-700" title="Undo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
                </button>
                <button onclick="formatDoc('redo')" class="p-2 hover:bg-gray-300 rounded text-gray-700" title="Redo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 3.7"></path></svg>
                </button>
            </div>

            <div class="w-px h-8 bg-gray-300 mx-1"></div>

            <!-- Actions Group -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1 gap-1">
                <button onclick="printDoc()" class="p-2 hover:bg-gray-300 rounded text-gray-700" title="Print">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                </button>
                <button onclick="shareDoc()" class="p-2 hover:bg-gray-300 rounded text-gray-700" title="Share">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                </button>
            </div>
        </div>

        <!-- Editor Area (Print Section) -->
        <div id="printSection" class="flex-grow p-6 relative bg-white overflow-hidden flex flex-col cursor-text" onclick="document.getElementById('resultText').focus()">
            
            <!-- Rich Text Editable Div -->
            <div id="resultText" contenteditable="true" class="w-full h-full text-lg text-gray-800 outline-none leading-relaxed overflow-y-auto pb-24" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶â‡¶†‡¶¨‡ßá..." spellcheck="false"></div>

            <!-- New Live Subtitle / Interim Display (Floating at bottom) -->
            <div id="interimDisplay" class="hidden absolute bottom-16 left-1/2 transform -translate-x-1/2 w-3/4 max-w-2xl bg-gray-900/90 backdrop-blur text-white text-center px-6 py-3 rounded-2xl shadow-xl z-20 transition-all duration-200 border border-gray-700">
                <p class="text-sm text-gray-400 mb-1 font-medium">‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...</p>
                <p id="interimText" class="text-lg font-semibold tracking-wide"></p>
            </div>

            <!-- Listening Indicator -->
            <div id="listeningIndicator" class="hidden absolute bottom-6 right-6 flex items-center gap-1 bg-red-50 px-3 py-1 rounded-full border border-red-100 shadow-sm select-none z-10">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce delay-200"></div>
                <span class="text-xs text-red-600 font-medium ml-1">‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...</span>
            </div>
        </div>

        <!-- Floating Translate Button -->
        <button id="translateBtn" class="hidden fixed bg-white text-gray-700 border border-gray-200 shadow-lg rounded-lg px-3 py-1.5 text-sm font-medium z-50 flex items-center gap-2 hover:bg-blue-50 hover:text-blue-600 transition-all transform -translate-x-1/2 -translate-y-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 8l6 6"></path><path d="M4 14l6-6 2-3"></path><path d="M2 5h12"></path><path d="M7 2h1"></path><path d="M22 22l-5-10-5 10"></path><path d="M14 18h6"></path></svg>
            ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ (Translate)
        </button>

        <!-- Footer Actions -->
        <div class="bg-gray-50 p-4 border-t border-gray-200 flex flex-wrap justify-between items-center gap-3">
            <button id="clearBtn" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg transition-colors text-sm font-medium flex items-center gap-2 border border-red-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶® (Clear)
            </button>

            <div class="flex gap-2">
                <button id="copyBtn" class="bg-white hover:bg-gray-100 text-gray-700 border border-gray-300 px-4 py-2 rounded-lg transition-all shadow-sm active:scale-95 text-sm font-medium flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    ‡¶ï‡¶™‡¶ø (Copy)
                </button>
                <button id="downloadBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-all shadow-sm active:scale-95 text-sm font-medium flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    ‡¶∏‡ßá‡¶≠ (Save)
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50">
        ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
    </div>

    <script>
        // DOM Elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resultText = document.getElementById('resultText');
        const statusText = document.getElementById('statusText');
        const interimDisplay = document.getElementById('interimDisplay');
        const interimTextContent = document.getElementById('interimText');
        const clearBtn = document.getElementById('clearBtn');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const listeningIndicator = document.getElementById('listeningIndicator');
        const languageSelect = document.getElementById('languageSelect');
        const toast = document.getElementById('toast');
        const translateBtn = document.getElementById('translateBtn');

        // Text Formatting Functions
        function formatDoc(cmd, value = null) {
            if (value) {
                document.execCommand(cmd, false, value);
            } else {
                document.execCommand(cmd);
            }
            resultText.focus();
        }

        function printDoc() {
            window.print();
        }

        async function shareDoc() {
            const text = resultText.innerText;
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: '‡¶∏‡ßç‡¶™‡¶ø‡¶ö ‡¶ü‡ßÅ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü',
                        text: text
                    });
                    showToast("‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
                } catch (err) {
                    console.log('Error sharing:', err);
                }
            } else {
                // Fallback
                copyToClipboard();
                showToast("‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá ‡¶®‡¶æ)");
            }
        }

        function copyToClipboard() {
            if (!resultText.innerText.trim()) {
                showToast("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶®‡ßá‡¶á");
                return;
            }
            
            // For ContentEditable div copying
            const range = document.createRange();
            range.selectNodeContents(resultText);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                document.execCommand('copy');
                showToast("‡¶≤‡ßá‡¶ñ‡¶æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            } catch (err) {
                showToast("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
            }
            selection.removeAllRanges();
        }

        // --- TRANSLATE BUTTON LOGIC ---
        function handleSelection() {
            const selection = window.getSelection();
            
            // Check if text is selected and it is not empty
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const selectedText = selection.toString().trim();
                
                if (selectedText.length === 0) {
                    translateBtn.classList.add('hidden');
                    return;
                }

                // Ensure selection is inside the editor
                if (!resultText.contains(selection.anchorNode) && !resultText.contains(selection.focusNode)) {
                     translateBtn.classList.add('hidden');
                     return;
                }

                // Show button above selection
                translateBtn.classList.remove('hidden');
                
                // Calculate position relative to viewport
                const top = rect.top + window.scrollY - 10; // 10px spacing
                const left = rect.left + window.scrollX + (rect.width / 2);
                
                translateBtn.style.top = `${top}px`;
                translateBtn.style.left = `${left}px`;
                
                // Attach click event for translation
                translateBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // Open Google Translate in new tab
                    const url = `https://translate.google.com/?sl=auto&tl=en&text=${encodeURIComponent(selectedText)}`;
                    window.open(url, '_blank');
                    
                    // Hide button after click
                    translateBtn.classList.add('hidden');
                };

            } else {
                translateBtn.classList.add('hidden');
            }
        }

        // Listen for selection changes
        document.addEventListener('mouseup', handleSelection);
        document.addEventListener('keyup', (e) => {
            if (e.key === 'Shift' || e.key.startsWith('Arrow')) {
                handleSelection();
            }
        });
        
        // Hide button when starting to select again
        document.addEventListener('mousedown', (e) => {
            if (e.target !== translateBtn) {
                translateBtn.classList.add('hidden');
            }
        });
        // --- END TRANSLATE LOGIC ---


        // Speech Recognition Setup
        let recognition;
        let isRecording = false;

        // Restart recording on language change
        languageSelect.addEventListener('change', () => {
            if (isRecording) {
                stopRecording();
                setTimeout(startRecording, 500);
            }
        });

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
        } else {
            alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡ßç‡¶™‡¶ø‡¶ö ‡¶ü‡ßÅ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§ ‡¶ï‡ßç‡¶∞‡ßã‡¶Æ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            startBtn.disabled = true;
        }

        function startRecording() {
            if (!recognition) return;
            recognition.lang = languageSelect.value;
            recognition.start();
        }

        function stopRecording() {
            if (!recognition) return;
            recognition.stop();
        }

        // Button Actions
        startBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
        clearBtn.addEventListener('click', () => {
            if(resultText.innerText.trim() === "") return;
            if(confirm("‡¶∏‡¶¨ ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                resultText.innerHTML = "";
                showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
            }
        });
        copyBtn.addEventListener('click', copyToClipboard);
        downloadBtn.addEventListener('click', () => {
            const text = resultText.innerText;
            if (!text.trim()) {
                showToast("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶®‡ßá‡¶á");
                return;
            }
            const blob = new Blob([text], { type: 'text/plain' });
            const anchor = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            anchor.download = `speech-doc-${timestamp}.txt`;
            anchor.href = window.URL.createObjectURL(blob);
            anchor.click();
            showToast("‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
        });

        // Recognition Events
        if (recognition) {
            recognition.onstart = () => {
                isRecording = true;
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                statusText.innerText = "‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...";
                statusText.className = "text-sm font-bold text-green-600 animate-pulse";
                stopBtn.classList.add('mic-active');
                listeningIndicator.classList.remove('hidden');
                
                // Show subtitle box immediately
                interimDisplay.classList.remove('hidden');
                interimTextContent.innerText = "";
                
                resultText.focus(); 
            };

            recognition.onend = () => {
                isRecording = false;
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                statusText.innerText = "‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶¨‡¶®‡ßç‡¶ß";
                statusText.className = "text-sm font-medium text-gray-500";
                stopBtn.classList.remove('mic-active');
                listeningIndicator.classList.add('hidden');
                
                // Hide subtitle box
                interimDisplay.classList.add('hidden');
                interimTextContent.innerText = '';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // Update Subtitle Box (Fast Feedback)
                if (interimTranscript) {
                    interimDisplay.classList.remove('hidden');
                    interimTextContent.innerText = interimTranscript;
                    statusText.innerText = "‡¶≤‡¶ø‡¶ñ‡¶õ‡¶ø...";
                } else {
                    // Keep box visible but empty if silence to prevent flickering
                    if(!finalTranscript) interimTextContent.innerText = "...";
                }

                if (finalTranscript) {
                    insertTextAtCursor(finalTranscript);
                    interimTextContent.innerText = ""; // Clear subtitle after committing
                    statusText.innerText = "‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...";
                }
            };
            
            recognition.onerror = (event) => {
                if (event.error === 'not-allowed') {
                    showToast("‡¶Æ‡¶æ‡¶á‡¶ï ‡¶è‡¶∞ ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶®‡ßá‡¶á!");
                }
                stopRecording();
            };
        }

        // Smart Text Insertion for ContentEditable
        function insertTextAtCursor(text) {
            resultText.focus();
            
            // Check if we need a leading space
            const selection = window.getSelection();
            let needsSpace = false;
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const startOffset = range.startOffset;
                const container = range.startContainer;
                
                // If not at start of line
                if (startOffset > 0) {
                    // Check previous char in text node
                    if (container.nodeType === 3) { // Text node
                        const prevChar = container.textContent.charAt(startOffset - 1);
                        if (prevChar && prevChar.trim() !== '') {
                            needsSpace = true;
                        }
                    }
                } else if (resultText.innerText.length > 0) {
                    // Start of a node, but editor has content (risky but safe default for dictation)
                     needsSpace = true; 
                }
            }

            if (needsSpace && !text.startsWith(' ')) {
                text = ' ' + text;
            }

            // Execute insert command (preserves Undo history)
            document.execCommand('insertText', false, text);
        }

        function showToast(message) {
            toast.innerText = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>